<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Дашборд Marmelandia</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 8px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <h2>Дашборд продаж — Marmelandia</h2>
  <div id="info" class="card">Инициализация...</div>
  <div id="result" class="card" style="display:none;"></div>
  <button id="refresh">Обновить данные</button>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    (function () {
      const info = document.getElementById('info');
      const result = document.getElementById('result');
      const btn = document.getElementById('refresh');

      // Инициализация WebApp
      const tg = window.Telegram.WebApp;
      tg.expand();

      // Для простоты используем initDataUnsafe (неверифицированный)
      const init = tg.initDataUnsafe || {};
      const user = init.user || {};
      const userId = user.id;

      if (!userId) {
        info.innerText = 'Не удалось получить user_id. Откройте виджет из бота (нажмите кнопку "Открыть дашборд продаж" в чате).';
        return;
      }
      info.innerText = 'Получен user_id: ' + userId + '. Запрашиваем данные...';

      async function load() {
        info.innerText = 'Запрашиваем продажи для user_id: ' + userId + ' ...';
        try {
          const resp = await fetch('/api/sales?user_id=' + encodeURIComponent(userId));
          const json = await resp.json();
          if (!resp.ok) {
            result.style.display = 'block';
            result.innerHTML = '<strong>Ошибка:</strong> ' + JSON.stringify(json);
            info.innerText = 'Ошибка получения данных';
            return;
          }
          info.innerText = 'Данные получены.';
          result.style.display = 'block';
          result.innerHTML = '<pre>' + JSON.stringify(json, null, 2) + '</pre>';
        } catch (e) {
          info.innerText = 'Ошибка сети: ' + e.message;
          result.style.display = 'block';
          result.innerHTML = '<strong>Ошибка сети</strong>: ' + e.message;
        }
      }

      btn.addEventListener('click', load);

      // Авто-загрузка при открытии
      load();
    })();
  </script>
</body>
</html>
