<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0B0F14; --card:#121923; --text:#EAF0FF; --muted:#93A4C7;
      --accent:#4DA3FF; --danger:#FF5A6A; --line: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box;}
    html, body { height:100%; margin:0; padding:0; overflow:hidden; background:var(--bg); color:var(--text); }

    /* Telegram WebApp –≤—ã—Å–æ—Ç–∞ */
    .app{
      height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));
      min-height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));
      padding: calc(16px + env(safe-area-inset-top))
               calc(16px + env(safe-area-inset-right))
               calc(16px + env(safe-area-inset-bottom))
               calc(16px + env(safe-area-inset-left));
      display:flex; flex-direction:column; gap:14px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;}
    .title{font-size:20px;font-weight:900;letter-spacing:.2px;}
    .sub{font-size:12px;color:var(--muted);}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(77,163,255,.15);color:var(--accent);white-space:nowrap;}
    .badge.danger{background:rgba(255,90,106,.15);color:var(--danger);}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
    .card{
      background:var(--card);border-radius:16px;padding:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      display:flex;flex-direction:column;gap:10px;min-height:110px;border:1px solid var(--line);
    }
    .label{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .value{font-size:28px;font-weight:900;letter-spacing:.2px;}
    .value.small{font-size:22px;}

    .footer{
      margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:12px;
      color:var(--muted);font-size:12px;
    }
    .btn{
      border:1px solid var(--line);background:rgba(77,163,255,.18);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .btn.secondary{background:rgba(255,255,255,.06);}
    .btn:active{transform:scale(.99);}
    .spin{animation:spin .8s linear infinite;}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .hint{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);background:rgba(255,255,255,.04);
      border-radius:14px;padding:10px 12px;display:none;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –∫–ª—é—á–µ–π */
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); padding:16px; }
    .modal[hidden]{ display:none; }
    .modalCard{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.4);
      display:flex; flex-direction:column; gap:10px;
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modalTitle{font-size:16px;font-weight:900;}
    .xbtn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900;}
    .inp{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row .btn{flex:1; justify-content:center;}
    .keysStatus{font-size:12px;color:var(--muted);}
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title">–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div class="sub" id="subtitle">FBO ¬∑ –°–µ–≥–æ–¥–Ω—è ¬∑ Europe/Moscow</div>
      </div>
      <div class="badge" id="status">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </div>

    <div class="hint" id="hint"></div>

    <div class="grid">
      <div class="card">
        <div class="label">–ó–∞–∫–∞–∑—ã <span class="badge">—à—Ç</span></div>
        <div class="value" id="orders">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ <span class="badge">‚ÇΩ</span></div>
        <div class="value small" id="ordersSum">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–û—Ç–º–µ–Ω—ã <span class="badge danger">—à—Ç</span></div>
        <div class="value" id="cancels">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ –æ—Ç–º–µ–Ω <span class="badge danger">‚ÇΩ</span></div>
        <div class="value small" id="cancelsSum">‚Äî</div>
      </div>
    </div>

    <div class="footer">
      <div id="updatedAt">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
        <button class="btn secondary" id="keysBtn">üîë –ö–ª—é—á–∏</button>
        <button class="btn" id="refreshBtn">
          <svg id="refreshIcon" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 3v7h-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal" hidden>
    <div class="modalCard" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="modalTitle">–ö–ª—é—á–∏ Ozon Seller</div>
        <button class="xbtn" id="closeModal">‚úï</button>
      </div>

      <div class="keysStatus" id="keysStatus"></div>

      <input class="inp" id="clientId" placeholder="Client ID" autocomplete="off" />
      <input class="inp" id="apiKey" placeholder="API Key" autocomplete="off" />

      <div class="row">
        <button class="btn" id="saveKeys">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn secondary" id="deleteKeys">–£–¥–∞–ª–∏—Ç—å</button>
      </div>

      <div class="keysStatus">
        –ï—Å–ª–∏ ‚Äú–û—Ç–∫—Ä—ã—Ç—å‚Äù –∏–Ω–æ–≥–¥–∞ –ø—É—Å—Ç–æ ‚Äî –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª. –≠—Ç–æ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞.
      </div>
    </div>
  </div>

  <script>
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ "–Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç"
    window.addEventListener("error", (e) => {
      const msg = (e && e.message) ? e.message : "JS error";
      document.body.innerHTML = '<pre style="white-space:pre-wrap;padding:16px;color:#fff;background:#000;">' + msg + '</pre>';
    });
    window.addEventListener("unhandledrejection", (e) => {
      const msg = (e && e.reason) ? String(e.reason) : "Unhandled promise rejection";
      document.body.innerHTML = '<pre style="white-space:pre-wrap;padding:16px;color:#fff;background:#000;">' + msg + '</pre>';
    });

    const tg = window.Telegram?.WebApp;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const hintEl = $("hint");
    const updatedAtEl = $("updatedAt");
    const refreshBtn = $("refreshBtn");
    const refreshIcon = $("refreshIcon");

    const subtitleEl = $("subtitle");
    const ordersEl = $("orders");
    const ordersSumEl = $("ordersSum");
    const cancelsEl = $("cancels");
    const cancelsSumEl = $("cancelsSum");

    // modal
    const keysBtn = $("keysBtn");
    const modal = $("modal");
    const closeModal = $("closeModal");
    const clientIdInp = $("clientId");
    const apiKeyInp = $("apiKey");
    const saveKeysBtn = $("saveKeys");
    const deleteKeysBtn = $("deleteKeys");
    const keysStatus = $("keysStatus");

    function setStatus(text, danger=false){
      statusEl.textContent = text;
      statusEl.className = "badge" + (danger ? " danger" : "");
    }
    function showHint(text){
      hintEl.textContent = text || "";
      hintEl.style.display = text ? "block" : "none";
    }
    function setLastUpdated(iso){
      const d = iso ? new Date(iso) : new Date();
      updatedAtEl.textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + d.toLocaleString("ru-RU");
    }
    function fmtMoneyFromCents(cents){
      if (cents === null || cents === undefined) return "‚Äî";
      const rub = Number(cents) / 100;
      return new Intl.NumberFormat("ru-RU", {minimumFractionDigits:2, maximumFractionDigits:2}).format(rub);
    }

    function applyFullscreen(){
      if (!tg) return;
      tg.ready();
      tg.expand();
      tg.disableVerticalSwipes?.();
      tg.requestFullscreen?.();
    }

    // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ JS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å—Ç–∞—Ç—É—Å –Ω–µ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è. –ü–æ—ç—Ç–æ–º—É —Å—Ç–∞–≤–∏–º —è–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä.
    setStatus("js ok");

    applyFullscreen();
    try { tg?.onEvent?.("viewportChanged", applyFullscreen); } catch(e){}

    function tgHeader(){
      const initData = tg?.initData || "";
      return initData ? { "X-Tg-Init-Data": initData, "x-telegram-init-data": initData } : {};
    }

    // Modal open/close
    function openModal(){
      modal.hidden = false;
      keysStatus.textContent = "";
      loadKeys().catch(()=>{});
    }
    function close(){
      modal.hidden = true;
    }

    keysBtn.addEventListener("click", openModal);
    closeModal.addEventListener("click", close);
    modal.addEventListener("click", (e)=>{ if (e.target === modal) close(); });

    saveKeysBtn.addEventListener("click", async ()=>{
      keysStatus.textContent = "";
      const clientId = clientIdInp.value.trim();
      const apiKey = apiKeyInp.value.trim();
      if (!clientId || !apiKey){
        keysStatus.textContent = "–ó–∞–ø–æ–ª–Ω–∏ Client ID –∏ API Key";
        return;
      }
      const r = await fetch("/api/keys", {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...tgHeader() },
        body: JSON.stringify({ clientId, apiKey })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.ok){
        keysStatus.textContent = j.error || ("HTTP " + r.status);
        return;
      }
      keysStatus.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ";
      close();
      await loadDashboard();
    });

    deleteKeysBtn.addEventListener("click", async ()=>{
      keysStatus.textContent = "";
      const r = await fetch("/api/keys", { method:"DELETE", headers: tgHeader() });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.ok){
        keysStatus.textContent = j.error || ("HTTP " + r.status);
        return;
      }
      clientIdInp.value = "";
      apiKeyInp.value = "";
      keysStatus.textContent = "–£–¥–∞–ª–µ–Ω–æ ‚úÖ";
      await loadDashboard();
    });

    async function loadKeys(){
      const r = await fetch("/api/keys", { headers: tgHeader() });
      const j = await r.json().catch(()=>({}));

      if (r.status === 401){
        keysStatus.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª initData). –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —É –±–æ—Ç–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.";
        return;
      }
      if (!r.ok){
        keysStatus.textContent = "–ö–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–≤–µ–¥–∏ Client ID / API Key.";
        return;
      }

      keysStatus.textContent = "–ö–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã ‚úÖ";
      clientIdInp.value = j.clientId || "";
      apiKeyInp.value = "";
    }

    async function loadDashboard(){
      showHint("");
      setStatus("–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶");

      ordersEl.textContent = "‚Äî";
      ordersSumEl.textContent = "‚Äî";
      cancelsEl.textContent = "‚Äî";
      cancelsSumEl.textContent = "‚Äî";

      if (!tg?.initData){
        showHint("–û—Ç–∫—Ä—ã—Ç–æ –±–µ–∑ initData (—á–∞—Å—Ç–æ –ø—Ä–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª). –ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –∏–ª–∏ –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —É –±–æ—Ç–∞.");
      }

      const r = await fetch("/api/dashboard/today", { headers: tgHeader() });
      const data = await r.json().catch(()=>({}));

      if (r.status === 401){
        setStatus("–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞", true);
        showHint("Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é. –û—Ç–∫—Ä–æ–π WebApp —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —É –±–æ—Ç–∞.");
        return;
      }
      if (!r.ok || data.error){
        if (data.error === "no_creds" || data.error === "keys_not_found"){
          setStatus("–Ω—É–∂–Ω—ã –∫–ª—é—á–∏", true);
          showHint("–ù–∞–∂–º–∏ ¬´–ö–ª—é—á–∏¬ª –∏ –≤–≤–µ–¥–∏ Client ID / API Key.");
          return;
        }
        setStatus("–æ—à–∏–±–∫–∞", true);
        showHint(data.error || ("HTTP " + r.status));
        return;
      }

      if (data.title) subtitleEl.textContent = data.title;

      ordersEl.textContent = data.orders ?? data.ordersCount ?? "‚Äî";
      ordersSumEl.textContent = fmtMoneyFromCents(data.orders_sum ?? data.ordersAmount);
      cancelsEl.textContent = data.cancels ?? data.cancelsCount ?? "‚Äî";
      cancelsSumEl.textContent = fmtMoneyFromCents(data.cancels_sum ?? data.cancelsAmount);

      setLastUpdated(data.updated_at);
      setStatus("–∞–∫—Ç—É–∞–ª—å–Ω–æ");
    }

    function setLoading(v){
      refreshBtn.disabled = v;
      if (v) refreshIcon.classList.add("spin");
      else refreshIcon.classList.remove("spin");
    }

    // –ê–≤—Ç–æ–ø–æ–ø—ã—Ç–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (–Ω–∞ –º–æ–±–∏–ª–µ tg.initData –∏–Ω–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–µ —Å—Ä–∞–∑—É)
    let tries = 0;
    async function boot(){
      setLoading(true);
      try { applyFullscreen(); await loadDashboard(); }
      finally { setLoading(false); }

      if (!(tg?.initData || "") && tries < 6){
        tries += 1;
        setTimeout(boot, 350);
      }
    }

    refreshBtn.addEventListener("click", ()=>{
      tries = 0;
      boot();
    });

    document.addEventListener("visibilitychange", ()=>{
      if (!document.hidden){
        tries = 0;
        applyFullscreen();
        boot();
      }
    });

    boot();
  </script>
</body>
</html>
