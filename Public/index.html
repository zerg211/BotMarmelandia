<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0B0F14; --card:#121923; --text:#EAF0FF; --muted:#93A4C7;
      --accent:#4DA3FF; --danger:#FF5A6A; --success:#3CCB7F; --line: rgba(255,255,255,.08);

      /* ‚úÖ –í–ï–†–•–ù–ò–ô "–§–£–¢–ï–†" (–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∏–∂–µ —à–∞–ø–∫–∏ Telegram) */
      --top-gap: 44px;            /* –µ—Å–ª–∏ –º–∞–ª–æ/–º–Ω–æ–≥–æ ‚Äî –º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ */
    }
    *{box-sizing:border-box;}

    html, body { height: 100%; overflow: auto; }
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .app{
      height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));
      min-height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));

      /* ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ top-gap */
      padding:
        calc(var(--top-gap) + env(safe-area-inset-top) + 16px)
        calc(16px + env(safe-area-inset-right))
        calc(16px + env(safe-area-inset-bottom))
        calc(16px + env(safe-area-inset-left));

      display:flex;flex-direction:column;gap:14px;overflow-y:auto;
    }

    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;}
    .title{font-size:20px;font-weight:900;letter-spacing:.2px;}
    .sub{font-size:12px;color:var(--muted);}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(77,163,255,.15);color:var(--accent);white-space:nowrap;}
    .badge.danger{background:rgba(255,90,106,.15);color:var(--danger);}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
    .card{ 
      background:var(--card);border-radius:16px;padding:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      display:flex;flex-direction:column;gap:10px;min-height:110px;border:1px solid var(--line);
    }
    .label{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .value{font-size:28px;font-weight:900;letter-spacing:.2px;}
    .value.small{font-size:22px;}
    .value.pos{color:var(--success);}
    .value.neg{color:var(--danger);}

    /* –±–∞–ª–∞–Ω—Å: –¥–∏–Ω–∞–º–∏–∫–∞ –∫ –Ω–∞—á–∞–ª—É –¥–Ω—è */
    .delta{font-size:12px;color:var(--muted);line-height:1.2;margin-top:-6px;}
    .delta.pos{color:var(--success);}
    .delta.neg{color:var(--danger);}
    .footer{
      margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:12px;
      color:var(--muted);font-size:12px;
    }
    .btn{
      border:1px solid var(--line);background:rgba(77,163,255,.18);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .btn.secondary{background:rgba(255,255,255,.06);}
    .btn:active{transform:scale(.99);}
    .spin{animation:spin .8s linear infinite;}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}


.mini-list{
  font-size:12px;color:var(--muted);line-height:1.35;
  max-height:72px;overflow:auto;padding-right:4px;
}
.mini-list .row{display:flex;justify-content:space-between;gap:10px;}
.mini-list .k{color:var(--text);font-weight:700;}


/* –±–∞–ª–∞–Ω—Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π */
.card.clickable{cursor:pointer;}
.card.clickable:active{transform:scale(.99);}

/* –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –±–∞–ª–∞–Ω—Å—É (–º–æ–¥–∞–ª–∫–∞) */
.ops-meta{font-size:12px;color:var(--muted);}
.ops-list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto;padding-right:4px;}
.op{
  border:1px solid var(--line);border-radius:14px;padding:10px 10px;
  background:rgba(255,255,255,.03);
  display:flex;flex-direction:column;gap:6px;
}
.op-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
.op-title{font-size:13px;font-weight:800;line-height:1.2;}
.op-sub{font-size:12px;color:var(--muted);line-height:1.2;}
.op-amt{font-size:13px;font-weight:900;white-space:nowrap;}
.op-amt.pos{color:var(--success);}
.op-amt.neg{color:var(--danger);}
.op-foot{display:flex;flex-wrap:wrap;gap:8px;}
.pill{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);}

    /* modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal{
      width:min(520px,100%);
      background:var(--card);border:1px solid var(--line);
      border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.5);
      padding:16px;display:flex;flex-direction:column;gap:12px;
    }
    .modal h3{margin:0;font-size:16px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{font-size:12px;color:var(--muted);}
    .field input{
      width:100%;padding:12px 12px;border-radius:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.04);
      color:var(--text);outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row .btn{flex:1;}
    .err{font-size:12px;color:var(--danger);display:none;}
    @media (max-width:380px){.value{font-size:24px}.card{min-height:96px}}
  
.op.clickable{cursor:pointer;}
.op-time{font-size:12px;color:var(--muted);margin-top:4px;}
.op-details{margin-top:10px;border-top:1px solid var(--line);padding-top:10px;display:none;flex-direction:column;gap:6px;}
.op-line{display:flex;justify-content:space-between;gap:10px;font-size:13px;}
.op-line .t{color:var(--text);font-weight:700;}
.op-line .a{font-weight:900;}
.op-line .a.pos{color:var(--success);}
.op-line .a.neg{color:var(--danger);}
.op-note{margin-top:8px;font-size:12px;color:var(--muted);}

    /* tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab-btn{flex:1;min-width:140px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;}
    .tab-btn.active{background:rgba(77,163,255,.18);border-color:rgba(77,163,255,.6);}
    .tab-content{display:none;flex-direction:column;gap:14px;}
    .tab-content.active{display:flex;}

    /* ozon calc */
    .section-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
    .title.sm{font-size:18px;}
    .calc{display:flex;flex-direction:column;gap:12px;}
    .calc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;}
    .calc-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:12px;}
    .calc .field-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    .calc label{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;gap:6px;}
    .calc input{width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);outline:none;}
    .calc input:focus{border-color:rgba(77,163,255,.6);}
    .calc select{width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);outline:none;}
    .calc .fieldset{display:flex;flex-direction:column;gap:8px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.02);}
    .calc .fieldset legend{font-size:11px;color:var(--muted);padding:0 4px;}
    .calc .tags{display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:var(--muted);}
    .calc .tag{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);}
    .calc-hint{font-size:12px;color:var(--muted);line-height:1.4;}
    .calc-note{font-size:11px;color:var(--muted);line-height:1.4;background:rgba(255,255,255,.03);border:1px dashed var(--line);border-radius:12px;padding:8px 10px;}
    .calc-summary{display:flex;flex-direction:column;gap:10px;}
    .calc-metric{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid var(--line);}
    .calc-metric .k{color:var(--muted);font-size:12px;}
    .calc-metric .v{font-weight:900;}
    .calc-metric .v.pos{color:var(--success);}
    .calc-metric .v.neg{color:var(--danger);}
    .calc-badge{font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(77,163,255,.14);color:var(--accent);}
    .calc-breakdown{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;font-size:12px;color:var(--muted);}
    .calc-breakdown .line{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-radius:12px;background:rgba(255,255,255,.02);border:1px solid var(--line);}
    .calc-breakdown .line .v{font-weight:800;color:var(--text);}
    .svd-row{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);}
    .svd-row input[type="range"]{flex:1;accent-color:var(--accent);}
    .toggle-row{display:flex;gap:8px;flex-wrap:wrap;}
    .toggle-row .toggle-btn{flex:0 0 auto;min-width:120px;}
    .toggle-btn{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);padding:8px 12px;border-radius:12px;font-weight:800;cursor:pointer;}
    .toggle-btn.active{background:rgba(77,163,255,.18);border-color:rgba(77,163,255,.6);}
    .pill-radio{display:flex;gap:8px;flex-wrap:wrap;}
    .pill-radio button{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);padding:8px 12px;border-radius:12px;font-weight:800;cursor:pointer;}
    .pill-radio button.active{background:rgba(77,163,255,.18);border-color:rgba(77,163,255,.6);}
    .inline-note{font-size:11px;color:var(--muted);}
    .hero-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;}
    .mode-card{background:linear-gradient(135deg, rgba(77,163,255,.16), rgba(60,203,127,.08));border:1px solid rgba(77,163,255,.35);}
    .mode-pill{padding:6px 10px;border-radius:12px;font-size:12px;background:rgba(0,0,0,.16);border:1px solid var(--line);color:var(--text);}
    .svd-legend{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted);}
    .svd-value{font-weight:800;color:var(--accent);}
    .badge-row{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:var(--muted);}
    .badge-row .pill{border-color:rgba(255,255,255,.08);}
    .typeahead{position:relative;}
    .typeahead-list{position:absolute;left:0;right:0;top:100%;margin-top:6px;border:1px solid var(--line);background:rgba(16,22,31,.96);
      border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);max-height:220px;overflow:auto;display:none;z-index:20;}
    .typeahead-item{padding:10px 12px;font-size:13px;color:var(--text);cursor:pointer;display:flex;flex-direction:column;gap:2px;}
    .typeahead-item:hover,.typeahead-item:active{background:rgba(77,163,255,.14);}
    .typeahead-item .meta{font-size:11px;color:var(--muted);}

</style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title" id="title">–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div class="sub" id="subtitle">FBO ¬∑ –°–µ–≥–æ–¥–Ω—è ¬∑ Europe/Moscow</div>
      </div>
      <div class="badge" id="status">–≥–æ—Ç–æ–≤–æ</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard">–î–∞—à–±–æ—Ä–¥</button>
      <button class="tab-btn" data-tab="calc">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä Ozon</button>
    </div>

    <div id="dashboardTab" class="tab-content active">
      <div class="grid">
        <div class="card">
          <div class="label">–ó–∞–∫–∞–∑—ã <span class="badge">—à—Ç</span></div>
          <div class="value" id="orders">‚Äî</div>
        </div>
        <div class="card">
          <div class="label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ <span class="badge">‚ÇΩ</span></div>
          <div class="value small" id="ordersSum">‚Äî</div>
        </div>
        <div class="card">
          <div class="label">–û—Ç–º–µ–Ω—ã <span class="badge danger">—à—Ç</span></div>
          <div class="value" id="cancels">‚Äî</div>
        </div>
        <div class="card">
          <div class="label">–°—É–º–º–∞ –æ—Ç–º–µ–Ω <span class="badge danger">‚ÇΩ</span></div>
          <div class="value small" id="cancelsSum">‚Äî</div>
        </div>

        <div class="card">
          <div class="label">–í—ã–∫—É–ø—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge">‚ÇΩ</span></div>
          <div class="value small pos" id="buyoutsSum">‚Äî</div>
        </div>
        <div class="card">
          <div class="label">–í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge danger">‚ÇΩ</span></div>
          <div class="value small neg" id="returnsSum">‚Äî</div>
        </div>

        <div class="card" id="balanceCard">
          <div class="label">–ë–∞–ª–∞–Ω—Å –∫–∞–±–∏–Ω–µ—Ç–∞ <span class="badge">‚ÇΩ</span></div>
          <div class="value small" id="balance">‚Äî</div>
          <div class="delta" id="balanceDelta"></div>
        </div>
      </div>
    </div>

    <div id="calcTab" class="tab-content">
      <div class="calc">
        <div class="section-head">
          <div>
            <div class="title sm">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä Ozon</div>
            <div class="sub">–ü–æ–≤—Ç–æ—Ä—è–µ—Ç UX ecomunit: –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∫–æ–º–∏—Å—Å–∏–π, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ FBO/FBS —Å –ø–æ–ª–∑—É–Ω–∫–æ–º –°–í–î.</div>
          </div>
          <span class="calc-badge">‚ö° –æ–±–Ω–æ–≤–ª—ë–Ω</span>
        </div>

        <div class="hero-row">
          <div class="calc-card mode-card">
            <div class="label" style="color:var(--text);font-weight:800;">–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã</div>
            <div class="pill-radio" role="group" aria-label="–ú–æ–¥–µ–ª—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è" style="gap:10px;">
              <button type="button" class="fulfillment-btn active" data-mode="fbo">FBO ¬∑ —Å–∫–ª–∞–¥ Ozon</button>
              <button type="button" class="fulfillment-btn" data-mode="fbs">FBS ¬∑ —Å–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞</button>
            </div>
            <div class="badge-row" id="modeMeta"></div>
            <div class="svd-legend">
              <span>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ (–°–í–î)</span>
              <span class="svd-value" id="svdValue">50</span>
            </div>
            <div class="svd-row">
              <span>0</span>
              <input id="calcSvd" type="range" min="0" max="100" value="50" />
              <span>100</span>
            </div>
            <div class="inline-note">–ß–µ–º –≤—ã—à–µ –°–í–î, —Ç–µ–º –¥–æ—Ä–æ–∂–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∞. –ë–ª–∏–∂–µ –∫ –ª–æ–≥–∏–∫–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ Ozon: —É—á–∏—Ç—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É —á–µ—Ä–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞.</div>
            <div class="field-row">
              <label>–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∫—É–ø–∞, %<input id="calcBuyout" type="number" inputmode="decimal" placeholder="95" value="95" /></label>
              <label>–°–∫–∏–¥–∫–∞, %<input id="calcDiscount" type="number" inputmode="decimal" placeholder="10" value="0" /></label>
            </div>
          </div>

          <div class="calc-card">
            <div class="fieldset">
              <legend>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞</legend>
              <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–ª–∏ —Ç–∏–ø, –∫–∞–∫ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ Ozon
                <div class="typeahead">
                  <input id="calcCategory" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–±–æ–≥—Ä–µ–≤" autocomplete="off" />
                  <div class="typeahead-list" id="categorySuggest"></div>
                </div>
              </label>
              <datalist id="categoryList"></datalist>
              <div class="inline-note" id="categoryHint">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∞ –∫–æ–º–∏—Å—Å–∏—é –ø–æ–¥—Å—Ç–∞–≤–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
              <label>–ö–æ–º–∏—Å—Å–∏—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞, %
                <input id="calcCommission" type="number" inputmode="decimal" placeholder="15" />
              </label>
            </div>
            <div class="fieldset">
              <legend>–§–∏–Ω–∞–Ω—Å—ã</legend>
              <div class="field-row">
                <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏, ‚ÇΩ<input id="calcPrice" type="number" inputmode="decimal" placeholder="1499" /></label>
                <label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, ‚ÇΩ<input id="calcCost" type="number" inputmode="decimal" placeholder="650" /></label>
              </div>
              <div class="field-row">
                <label>–†–µ–∫–ª–∞–º–∞, % –æ—Ç —Ü–µ–Ω—ã<input id="calcAds" type="number" inputmode="decimal" placeholder="8" value="0" /></label>
                <label>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ<input id="calcOther" type="number" inputmode="decimal" placeholder="35" value="0" /></label>
              </div>
            </div>
          </div>
        </div>

        <div class="calc-grid">
          <div class="calc-card">
            <div class="fieldset">
              <legend>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ –≥–∞–±–∞—Ä–∏—Ç—ã</legend>
              <div class="toggle-row">
                <button type="button" class="toggle-btn active" id="dimsTab">–ì–∞–±–∞—Ä–∏—Ç—ã</button>
                <button type="button" class="toggle-btn" id="volumeTab">–û–±—ä—ë–º (–ª) + –≤–µ—Å</button>
              </div>
              <div id="dimsInputs">
                <div class="field-row">
                  <label>–î–ª–∏–Ω–∞, —Å–º<input id="calcLen" type="number" inputmode="decimal" placeholder="20" /></label>
                  <label>–®–∏—Ä–∏–Ω–∞, —Å–º<input id="calcWidth" type="number" inputmode="decimal" placeholder="15" /></label>
                </div>
                <div class="field-row">
                  <label>–í—ã—Å–æ—Ç–∞, —Å–º<input id="calcHeight" type="number" inputmode="decimal" placeholder="10" /></label>
                  <label>–í–µ—Å, –∫–≥<input id="calcWeight" type="number" inputmode="decimal" placeholder="0.9" /></label>
                </div>
              </div>
              <div id="volumeInputs" style="display:none;">
                <div class="field-row">
                  <label>–û–±—ä—ë–º, –ª<input id="calcVolume" type="number" inputmode="decimal" placeholder="3" /></label>
                  <label>–í–µ—Å, –∫–≥<input id="calcWeightAlt" type="number" inputmode="decimal" placeholder="0.9" /></label>
                </div>
              </div>
              <div class="tags" id="logisticsMeta"></div>
              <div class="calc-note">–£—á—ë—Ç –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ Ozon: –±–µ—Ä—ë–º –±–æ–ª—å—à–∏–π –∏–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ –æ–±—ä—ë–º–Ω–æ–≥–æ –≤–µ—Å–∞, —Ç–∞—Ä–∏—Ñ –ø–æ FBO/FBS –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –ø–æ –°–í–î. –í–æ–∑–≤—Ä–∞—Ç—ã —Å—á–∏—Ç–∞–µ–º –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É –≤—ã–∫—É–ø–∞.</div>
            </div>

            <div class="calc-hint">–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É, —Å–∫–∏–¥–∫—É –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî –∫–æ–º–∏—Å—Å–∏—è –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –õ–æ–≥–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–∞ Ozon: –ø–æ –≥–∞–±–∞—Ä–∏—Ç–∞–º/–≤–µ—Å—É, –º–æ–¥–µ–ª–∏ FBO/FBS, –°–í–î –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—É –≤—ã–∫—É–ø–∞ —Å —É—á—ë—Ç–æ–º –æ–±—Ä–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.</div>
          </div>

          <div class="calc-card">
            <div class="calc-summary">
              <div class="calc-metric">
                <div class="k">–¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π</div>
                <div class="v" id="calcNetPrice">‚Äî</div>
              </div>
              <div class="calc-metric">
                <div class="k">–ö–æ–º–∏—Å—Å–∏—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞</div>
                <div class="v" id="calcCommissionAmt">‚Äî</div>
              </div>
              <div class="calc-metric">
                <div class="k">–†–µ–∫–ª–∞–º–∞</div>
                <div class="v" id="calcAdsAmt">‚Äî</div>
              </div>
            </div>
            <div class="calc-breakdown">
              <div class="line"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="v" id="calcCostLine">‚Äî</span></div>
              <div class="line"><span>–õ–æ–≥–∏—Å—Ç–∏–∫–∞</span><span class="v" id="calcLogisticsLine">‚Äî</span></div>
              <div class="line"><span>–ü—Ä–æ—á–∏–µ</span><span class="v" id="calcOtherLine">‚Äî</span></div>
              <div class="line"><span>–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—ã</span><span class="v" id="calcCosts">‚Äî</span></div>
            </div>
            <div class="calc-summary">
              <div class="calc-metric">
                <div class="k">–ü—Ä–∏–±—ã–ª—å —Å –µ–¥–∏–Ω–∏—Ü—ã</div>
                <div class="v" id="calcProfit">‚Äî</div>
              </div>
              <div class="calc-metric">
                <div class="k">–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å</div>
                <div class="v" id="calcMargin">‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div id="updatedAt">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn secondary" id="keysBtn">üîë –ö–ª—é—á–∏</button>
        <button class="btn" id="refreshBtn">
          <svg id="refreshIcon" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 3v7h-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- modal: api keys -->
  <div class="modal-backdrop" id="modalBg">
    <div class="modal">
      <h3>–ö–ª—é—á–∏ Ozon Seller</h3>

      <div class="field">
        <label>Client ID</label>
        <input id="clientId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 2396143" />
      </div>

      <div class="field">
        <label>Api-Key</label>
        <input id="apiKey" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 6157f0ba-..." />
      </div>

      <div class="err" id="modalErr">–û—à–∏–±–∫–∞</div>

      <div class="row">
        <button class="btn secondary" id="cancelBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- balance modal -->
  <div class="modal-backdrop" id="balModalBg">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h3 style="margin:0;">–ë–∞–ª–∞–Ω—Å: –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <button class="btn secondary" id="balCloseBtn" style="flex:0 0 auto;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="ops-meta" id="balMeta">‚Äî</div>
      <div class="err" id="balErr" style="display:none;"></div>
      <div class="ops-list" id="balOps">
        <div class="op">
          <div class="op-top">
            <div class="op-title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            <div class="op-amt">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    function applyFullscreen(){
      if (!tg) return;
      tg.ready();
      tg.expand();
      tg.disableVerticalSwipes?.();
      tg.requestFullscreen?.();
    }
    applyFullscreen();
    try { tg?.onEvent?.("viewportChanged", applyFullscreen); } catch(e) {}

    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const updatedAtEl = $("updatedAt");
    const refreshBtn = $("refreshBtn");
    const refreshIcon = $("refreshIcon");

    const modalBg = $("modalBg");

    const balModalBg = $("balModalBg");
    const balCloseBtn = $("balCloseBtn");
    const balMeta = $("balMeta");
    const balErr = $("balErr");
    const balOps = $("balOps");
    const balanceCard = $("balanceCard");

    const clientIdEl = $("clientId");
    const apiKeyEl = $("apiKey");
    const modalErr = $("modalErr");

    const calcInputs = {
      price: $("calcPrice"),
      cost: $("calcCost"),
      discount: $("calcDiscount"),
      commission: $("calcCommission"),
      ads: $("calcAds"),
      other: $("calcOther"),
      len: $("calcLen"),
      width: $("calcWidth"),
      height: $("calcHeight"),
      weight: $("calcWeight"),
      volume: $("calcVolume"),
      weightAlt: $("calcWeightAlt"),
      svd: $("calcSvd"),
      buyout: $("calcBuyout"),
      category: $("calcCategory"),
    };
    const calcOutputs = {
      netPrice: $("calcNetPrice"),
      commissionAmt: $("calcCommissionAmt"),
      adsAmt: $("calcAdsAmt"),
      costs: $("calcCosts"),
      costLine: $("calcCostLine"),
      logisticsLine: $("calcLogisticsLine"),
      otherLine: $("calcOtherLine"),
      profit: $("calcProfit"),
      margin: $("calcMargin"),
    };

    const svdValueEl = $("svdValue");
    const logisticsMeta = $("logisticsMeta");
    const modeMetaEl = $("modeMeta");
    const dimsTab = $("dimsTab");
    const volumeTab = $("volumeTab");
    const dimsInputs = $("dimsInputs");
    const volumeInputs = $("volumeInputs");
    const categoryHintEl = $("categoryHint");
    const categoryListEl = $("categoryList");
    const categorySuggestEl = $("categorySuggest");
    const fulfillmentButtons = document.querySelectorAll('.fulfillment-btn');

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function activateTab(name){
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === name;
        btn.classList.toggle('active', isActive);
      });
      tabContents.forEach((section) => {
        const isActive = section.id === `${name}Tab`;
        section.classList.toggle('active', isActive);
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    tabButtons.forEach((btn) => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));

    const rubFormatter = new Intl.NumberFormat("ru-RU", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function setStatus(text, danger=false){
      statusEl.textContent = text;
      statusEl.className = "badge" + (danger ? " danger" : "");
    }
    function setLastUpdated(iso){
      const d = iso ? new Date(iso) : new Date();
      updatedAtEl.textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + d.toLocaleString("ru-RU");
    }
    function fmtMoneyFromCents(cents){
      if (cents === null || cents === undefined) return "‚Äî";
      const rub = (Number(cents) / 100);
      return new Intl.NumberFormat("ru-RU", {minimumFractionDigits:2, maximumFractionDigits:2}).format(rub);
    }

    function fmtSigned(cents){
      const n = Number(cents || 0);
      const sign = n > 0 ? "+" : (n < 0 ? "‚àí" : "");
      const abs = Math.abs(n);
      return sign + fmtMoneyFromCents(abs);
    }

    function fmtRub(val){
      return `${rubFormatter.format(val)} ‚ÇΩ`;
    }

    function parseNumber(input){
      if (!input) return 0;
      const raw = String(input.value || input.placeholder || "0").replace(",", ".");
      const num = Number(raw);
      return Number.isFinite(num) ? num : 0;
    }

    let categories = [];
    let categoriesLoading = false;
    let commissionDirty = false;

    const fulfillmentBase = {
      fbo: [
        { maxWeight: 0.5, maxVolume: 5, base: 55 },
        { maxWeight: 2, maxVolume: 12, base: 75 },
        { maxWeight: 5, maxVolume: 25, base: 110 },
        { maxWeight: 10, maxVolume: 45, base: 150 },
        { maxWeight: 20, maxVolume: 120, base: 210 },
        { maxWeight: 40, maxVolume: 350, base: 310 },
        { maxWeight: Infinity, maxVolume: Infinity, base: 420 },
      ],
      fbs: [
        { maxWeight: 0.5, maxVolume: 5, base: 70 },
        { maxWeight: 2, maxVolume: 12, base: 95 },
        { maxWeight: 5, maxVolume: 25, base: 135 },
        { maxWeight: 10, maxVolume: 45, base: 185 },
        { maxWeight: 20, maxVolume: 120, base: 240 },
        { maxWeight: 40, maxVolume: 350, base: 340 },
        { maxWeight: Infinity, maxVolume: Infinity, base: 460 },
      ],
    };

    const norm = (s) => String(s || "").toLowerCase().trim();
    let categoriesLoadedFrom = null;
    let lastLiveCommission = null;
    let lastLogisticsQuote = null;
    let commissionFetchTs = 0;
    let logisticsFetchTs = 0;

    async function fetchCategoriesFromApi(){
      if (categoriesLoading) return;
      categoriesLoading = true;
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();
      if (!clientId || !apiKey) {
        categoryHintEl.textContent = "–î–æ–±–∞–≤—å—Ç–µ Client ID –∏ Api-Key, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞.";
        categoriesLoading = false;
        return;
      }
      try {
        categoryHintEl.textContent = "–¢—è–Ω–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ Ozon API...";
        const resp = await fetch("/api/ozon/categories", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ clientId, apiKey }) });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || resp.status);
        categories = (data?.categories || []).map((c) => ({
          name: c.path || c.name,
          path: c.path || c.name,
          category_id: c.category_id,
          keywords: (c.path || c.name || "").split(/[>/]/).map((p) => p.trim()).filter(Boolean),
          commission: {},
        }));
        categoriesLoadedFrom = data?.source || "Ozon API";
        setCategoryOptions(matchCategories(calcInputs.category?.value || ""));
        categoryHintEl.textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—ã –∏–∑ ${categoriesLoadedFrom} (${categories.length} —à—Ç.)`;
      } catch (e){
        categoryHintEl.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ Ozon API: ${e.message || e}`;
      } finally {
        categoriesLoading = false;
      }
    }

    function setCategoryOptions(list){
      if (!categoryListEl) return;
      categoryListEl.innerHTML = (list || []).map((c) => `<option value="${c.name}"></option>`).join("");
      renderCategorySuggest(list);
    }

    function renderCategorySuggest(list){
      if (!categorySuggestEl) return;
      if (!list || !list.length){
        categorySuggestEl.style.display = "none";
        categorySuggestEl.innerHTML = "";
        return;
      }
      categorySuggestEl.innerHTML = list.map((c) => {
        const meta = c.path && c.path !== c.name ? `<div class="meta">${c.path}</div>` : "";
        return `<div class="typeahead-item" data-id="${c.category_id}"><div>${c.name}</div>${meta}</div>`;
      }).join("");
      categorySuggestEl.style.display = "block";
    }

    function matchCategories(query, limit = 12){
      const q = norm(query);
      if (!q || q.length < 2) return [];
      if (!categories.length) return [];
      const tokens = q.split(/\s+/).filter(Boolean);
      const scored = [];
      categories.forEach((c) => {
        const candidates = [c.name, ...(c.keywords || [])].map(norm);
        let score = 0;
        candidates.forEach((cand) => {
          if (cand === q) score = Math.max(score, 120);
          else if (cand.startsWith(q)) score = Math.max(score, 100);
          else if (cand.includes(q)) score = Math.max(score, 80);
          tokens.forEach((t) => {
            if (t.length > 2 && cand.includes(t)) score = Math.max(score, 60);
          });
        });
        if (score > 0) scored.push({ cat: c, score });
      });
      return scored.sort((a, b) => b.score - a.score).slice(0, limit).map((s) => s.cat);
    }

    let fulfillmentMode = "fbo";
    let selectedCategory = null;
    let logisticsInputMode = "dims";

    function commissionForMode(cat){
      if (!cat) return null;
      const rate = cat.commission?.[fulfillmentMode];
      return Number.isFinite(rate) ? rate : null;
    }

    async function fetchCommissionFromApi(price){
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();
      if (!clientId || !apiKey || !selectedCategory?.category_id) return;
      const now = Date.now();
      if (now - commissionFetchTs < 800) return; // —Ç—Ä–æ—Ç—Ç–ª–∏–º
      commissionFetchTs = now;
      try {
        categoryHintEl.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é...";
        const payload = { items: [{ price, category_id: Number(selectedCategory.category_id), delivery_schema: fulfillmentMode.toUpperCase() }] };
        const resp = await fetch("/api/ozon/commission", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ clientId, apiKey, payload }) });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || resp.status);
        const item = data?.result?.items?.[0] || data?.result?.result?.items?.[0] || null;
        const rate = Number(item?.sales_percent || item?.commission_percent || 0);
        if (Number.isFinite(rate) && rate > 0){
          selectedCategory.commission = selectedCategory.commission || {};
          selectedCategory.commission[fulfillmentMode] = rate;
          lastLiveCommission = rate;
          if (!commissionDirty) calcInputs.commission.value = rate;
          categoryHintEl.textContent = `–ö–æ–º–∏—Å—Å–∏—è –∏–∑ Ozon API (${data?.source || "commission"}): ${rate}%`;
          updateCalc();
        } else {
          categoryHintEl.textContent = "Ozon API –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏, —É–∫–∞–∂–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.";
        }
      } catch (e){
        categoryHintEl.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é –∏–∑ Ozon API: ${e.message || e}`;
      }
    }

    function computeVolumeAndWeight(){
      let volumeLiters = 0;
      let weightKg = 0;
      if (logisticsInputMode === "volume"){
        volumeLiters = Math.max(0, parseNumber(calcInputs.volume));
        weightKg = Math.max(0, parseNumber(calcInputs.weightAlt));
      } else {
        const len = Math.max(0, parseNumber(calcInputs.len));
        const width = Math.max(0, parseNumber(calcInputs.width));
        const height = Math.max(0, parseNumber(calcInputs.height));
        volumeLiters = (len * width * height) / 1000; // —Å–º^3 -> –ª–∏—Ç—Ä—ã
        weightKg = Math.max(0, parseNumber(calcInputs.weight));
      }
      return { volumeLiters, weightKg };
    }

    function computeLogistics(baseTable, volumeLiters, weightKg, svdValue, buyoutPct){
      const volumetricWeight = Math.max(weightKg, volumeLiters / 5);
      const tier = baseTable.find((t) => volumetricWeight <= t.maxWeight && volumeLiters <= t.maxVolume) || baseTable[baseTable.length - 1];
      const svdCoeff = 0.55 + (svdValue / 100) * 0.9; // 0.55..1.45 ‚Äî –±–ª–∏–∂–µ –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É Ozon
      const forward = tier.base * svdCoeff;
      const returnShare = Math.max(0, Math.min(1, (100 - buyoutPct) / 100));
      const returnCoeff = 0.55 + (svdValue / 100) * 0.35;
      const reverse = tier.base * returnCoeff * returnShare;
      const total = forward + reverse;
      return { forward, reverse, total, volumetricWeight, tier, svdCoeff, returnShare };
    }

    async function fetchLogisticsFromApi({ price, volumeLiters, weightKg, svdValue, buyoutPct }){
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();
      if (!clientId || !apiKey) return;
      const now = Date.now();
      if (now - logisticsFetchTs < 800) return;
      logisticsFetchTs = now;
      try {
        const payload = {
          weight: weightKg,
          dimensions: {
            height: Math.max(0, parseNumber(calcInputs.height)),
            length: Math.max(0, parseNumber(calcInputs.len)),
            width: Math.max(0, parseNumber(calcInputs.width)),
          },
          volume: volumeLiters / 1000,
          price,
          delivery_schema: fulfillmentMode.toUpperCase(),
          delivery_time: svdValue,
          buyout_percent: buyoutPct,
        };
        const resp = await fetch("/api/ozon/logistics", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ clientId, apiKey, payload }) });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || resp.status);
        const res = data?.result?.delivery || data?.result || data;
        const total = Number(res?.total || res?.price || res?.amount || 0);
        if (Number.isFinite(total) && total > 0){
          lastLogisticsQuote = { total, raw: res };
          setLogisticsMeta({
            volumeLiters,
            volumetricWeight: weightKg,
            tier: { base: total, maxWeight: weightKg, maxVolume: volumeLiters },
            svdCoeff: 1,
            returnShare: buyoutPct / 100,
          });
          updateCalc();
        }
      } catch (e){
        logisticsMeta.innerHTML = `<span class="tag">Ozon API –ª–æ–≥–∏—Å—Ç–∏–∫–∞: ${e.message || e}</span>`;
      }
    }

    function setLogisticsMeta(info){
      if (!logisticsMeta) return;
      if (!info){
        logisticsMeta.innerHTML = "";
        return;
      }
      const tags = [
        `${logisticsInputMode === "volume" ? "–û–±—ä—ë–º" : "–ì–∞–±–∞—Ä–∏—Ç—ã"}: ${info.volumeLiters.toFixed(2)} –ª`,
        `–í–µ—Å –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞: ${info.volumetricWeight.toFixed(2)} –∫–≥`,
        `–ë–∞–∑–∞ —Ç–∞—Ä–∏—Ñ–∞: ${fmtRub(info.tier.base)}`,
        `–°–í–î –º–Ω–æ–∂–∏—Ç–µ–ª—å: ${info.svdCoeff.toFixed(2)}`,
        `–û–±—Ä–∞—Ç–∫–∞: ${(info.returnShare * 100).toFixed(0)}%`
      ];
      logisticsMeta.innerHTML = tags.map((t) => `<span class="tag">${t}</span>`).join("");
    }

    function updateModeMeta(){
      if (!modeMetaEl) return;
      const svd = calcInputs.svd?.value || "0";
      const desc = fulfillmentMode === "fbo" ? "FBO: –∑–∞–≤–æ–∑ –Ω–∞ —Å–∫–ª–∞–¥ Ozon, –Ω–∏–∂–µ —Ç–∞—Ä–∏—Ñ—ã, –Ω—É–∂–Ω–∞ –æ—Ç–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–∞–Ω–µ–µ." : "FBS: —Å–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞, —Ç–∞—Ä–∏—Ñ –≤—ã—à–µ –ø—Ä–∏ –¥–æ–ª–≥–æ–º –°–í–î, –Ω–æ –≥–∏–±—á–µ –æ—Ç–≥—Ä—É–∑–∫–∞.";
      modeMetaEl.innerHTML = [
        `<span class="pill">–ú–æ–¥–µ–ª—å: ${fulfillmentMode.toUpperCase()}</span>`,
        `<span class="pill">–°–í–î: ${svd}</span>`,
        `<span class="pill">${desc}</span>`,
      ].join("");
    }

    function applyCategory(cat){
      selectedCategory = cat;
      if (cat){
        const rate = commissionForMode(cat);
        if (rate !== null && !commissionDirty){
          calcInputs.commission.value = rate;
        }
        categoryHintEl.textContent = rate !== null
          ? `–ù–∞—à–ª–∏: ${cat.name}. –ö–æ–º–∏—Å—Å–∏—è –¥–ª—è ${fulfillmentMode.toUpperCase()}: ${rate}%`
          : `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat.name}. –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∏—Å—Å–∏—é –≤—Ä—É—á–Ω—É—é.`;
      } else {
        if (!commissionDirty) calcInputs.commission.value = "";
        categoryHintEl.textContent = "–ù–µ –Ω–∞—à–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–æ—á–Ω–µ–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é.";
      }
    }

    function chooseCategory(cat){
      commissionDirty = false;
      if (calcInputs.category && cat?.name){
        calcInputs.category.value = cat.name;
      }
      renderCategorySuggest([]);
      applyCategory(cat);
      if (cat){
        fetchCommissionFromApi(parseNumber(calcInputs.price));
      }
      updateCalc();
    }

    function handleCategoryInput(){
      const query = calcInputs.category?.value || "";
      if (!categories.length) fetchCategoriesFromApi();

      if (!query.trim()){
        selectedCategory = null;
        setCategoryOptions([]);
        renderCategorySuggest([]);
        if (!commissionDirty) calcInputs.commission.value = "";
        categoryHintEl.textContent = "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–∞–∫, –∫–∞–∫ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ Ozon.";
        updateCalc();
        return;
      }

      const matches = matchCategories(query, 20);
      setCategoryOptions(matches);

      const exact = matches.find((m) => norm(m.name) === norm(query));
      if (exact){
        chooseCategory(exact);
        return;
      }

      selectedCategory = null;
      categoryHintEl.textContent = matches.length
        ? `–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${matches.slice(0,5).map((m)=>m.name).join(" ¬∑ ")}`
        : (categories.length ? "–ù–µ –Ω–∞—à–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ –∫–∞—Ç–∞–ª–æ–≥–µ Ozon. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é." : "–ü–æ–¥—Ç—è–Ω–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ Ozon —á–µ—Ä–µ–∑ –∫–ª—é—á–∏ –≤ –º–µ–Ω—é üîë.");
      updateCalc();
    }

    function setFulfillment(mode){
      if (!mode) return;
      fulfillmentMode = mode;
      fulfillmentButtons.forEach((btn) => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('active', isActive);
      });
      const rate = commissionForMode(selectedCategory);
      if (rate !== null && !commissionDirty){
        calcInputs.commission.value = rate;
        if (selectedCategory){
          categoryHintEl.textContent = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${selectedCategory.name}. –ö–æ–º–∏—Å—Å–∏—è ${mode.toUpperCase()}: ${rate}%`;
        }
      }
      updateModeMeta();
      updateCalc();
    }

    function setLogisticsMode(mode){
      logisticsInputMode = mode;
      dimsTab?.classList.toggle('active', mode === "dims");
      volumeTab?.classList.toggle('active', mode === "volume");
      if (dimsInputs) dimsInputs.style.display = mode === "dims" ? "block" : "none";
      if (volumeInputs) volumeInputs.style.display = mode === "volume" ? "block" : "none";
      updateCalc();
    }

    function setCalcValue(el, value, { isPercent = false } = {}){
      if (!el) return;
      const cls = value > 0 ? "pos" : (value < 0 ? "neg" : "");
      el.className = `v ${cls}`.trim();
      if (value === null || value === undefined || !Number.isFinite(value)) {
        el.textContent = "‚Äî";
        return;
      }
      if (isPercent) {
        el.textContent = `${value.toFixed(1)} %`;
      } else {
        el.textContent = fmtRub(value);
      }
    }

    function updateCalc(){
      const price = Math.max(0, parseNumber(calcInputs.price));
      const discount = Math.max(0, parseNumber(calcInputs.discount));
      const cost = Math.max(0, parseNumber(calcInputs.cost));
      const commissionPct = Math.max(0, parseNumber(calcInputs.commission));
      const adsPct = Math.max(0, parseNumber(calcInputs.ads));
      const other = Math.max(0, parseNumber(calcInputs.other));
      const svdVal = Math.max(0, Math.min(100, parseNumber(calcInputs.svd)));
      const buyoutPct = Math.max(0, Math.min(100, parseNumber(calcInputs.buyout)));

      const { volumeLiters, weightKg } = computeVolumeAndWeight();
      const table = fulfillmentBase[fulfillmentMode] || fulfillmentBase.fbo;
      const logisticsInfo = computeLogistics(table, volumeLiters, weightKg, svdVal, buyoutPct);
      let logistics = lastLogisticsQuote?.total || logisticsInfo.total;
      if (!lastLogisticsQuote) setLogisticsMeta({ ...logisticsInfo, volumeLiters, svdValue: svdVal });

      const discountFactor = Math.max(0, 1 - discount / 100);
      const netPrice = price * discountFactor;
      if (selectedCategory?.category_id) fetchCommissionFromApi(netPrice || price || 0);
      const commissionAmt = netPrice * (commissionPct / 100);
      const adsAmt = netPrice * (adsPct / 100);

      if (!lastLogisticsQuote && weightKg && volumeLiters){
        fetchLogisticsFromApi({ price: netPrice || price || 0, volumeLiters, weightKg, svdValue: svdVal, buyoutPct });
      }

      const totalCosts = cost + logistics + other + commissionAmt + adsAmt;
      const profit = netPrice - totalCosts;
      const marginPct = netPrice > 0 ? (profit / netPrice) * 100 : 0;

      const variablePct = (commissionPct + adsPct) / 100;
      const fixedCosts = cost + logistics + other;

      setCalcValue(calcOutputs.netPrice, netPrice);
      setCalcValue(calcOutputs.commissionAmt, commissionAmt);
      setCalcValue(calcOutputs.adsAmt, adsAmt);
      setCalcValue(calcOutputs.costLine, cost);
      setCalcValue(calcOutputs.logisticsLine, logistics);
      setCalcValue(calcOutputs.otherLine, other);
      setCalcValue(calcOutputs.costs, totalCosts);
      setCalcValue(calcOutputs.profit, profit);
      setCalcValue(calcOutputs.margin, marginPct, { isPercent: true });
    }

    Object.values(calcInputs).forEach((el) => {
      el?.addEventListener("input", updateCalc);
    });
    calcInputs.commission?.addEventListener("input", () => { commissionDirty = true; lastLiveCommission = null; });
    calcInputs.category?.addEventListener("input", handleCategoryInput);
    calcInputs.category?.addEventListener("change", handleCategoryInput);
    categorySuggestEl?.addEventListener("click", (e) => {
      const item = e.target.closest(".typeahead-item");
      if (!item) return;
      const id = item.getAttribute("data-id");
      const cat = categories.find((c) => String(c.category_id) === String(id));
      if (cat) chooseCategory(cat);
    });
    calcInputs.svd?.addEventListener("input", () => {
      svdValueEl.textContent = calcInputs.svd.value || "0";
      updateModeMeta();
      updateCalc();
    });
    fulfillmentButtons.forEach((btn) => btn.addEventListener("click", () => setFulfillment(btn.dataset.mode)));
    dimsTab?.addEventListener("click", () => setLogisticsMode("dims"));
    volumeTab?.addEventListener("click", () => setLogisticsMode("volume"));

    setCategoryOptions([]);
    fetchCategoriesFromApi();
    setFulfillment("fbo");
    setLogisticsMode("dims");
    svdValueEl.textContent = calcInputs.svd?.value || "0";
    updateModeMeta();
    calcInputs.category?.addEventListener("focus", () => { if (!categories.length) fetchCategoriesFromApi(); });
    handleCategoryInput();
    updateCalc();

    function fmtOpWhen(iso, todayLocal){
      if (!iso) return "";
      // –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º—è –≤ Europe/Moscow, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∞–π–º–∑–æ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      const d = new Date(iso);

      const parts = new Intl.DateTimeFormat("ru-RU", {
        timeZone: "Europe/Moscow",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
      }).formatToParts(d);

      const get = (t)=>parts.find(p=>p.type===t)?.value || "";
      const dd = get("day");
      const mo = get("month");
      const yy = get("year");
      const hh = get("hour");
      const mm = get("minute");

      const mskDateStr = `${yy}-${mo}-${dd}`;

      if (mskDateStr === todayLocal) return `${hh}:${mm}`;
      return `${dd}.${mo}.${yy} ${hh}:${mm}`;
    }
    function setBalError(msg){
      if (!msg){
        balErr.style.display = "none";
        balErr.textContent = "";
      } else {
        balErr.style.display = "block";
        balErr.textContent = msg;
      }
    }


    function openModal(){
      modalErr.style.display = "none";
      clientIdEl.value = localStorage.getItem("ozon_clientId") || "";
      apiKeyEl.value = localStorage.getItem("ozon_apiKey") || "";
      modalBg.style.display = "flex";
      applyFullscreen();
    }
    function closeModal(){ modalBg.style.display = "none"; }


    function openBalModal(){
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();
      if (!clientId || !apiKey){
        setStatus("–Ω—É–∂–Ω—ã –∫–ª—é—á–∏", true);
        openModal();
        return;
      }

      balModalBg.style.display = "flex";
      setBalError("");
      balMeta.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      balOps.innerHTML = "";
      applyFullscreen();

      (async () => {
        try{
          const url = `/api/balance/ops/today?clientId=${encodeURIComponent(clientId)}&apiKey=${encodeURIComponent(apiKey)}`;
          const r = await fetch(url);
          const data = await r.json().catch(() => ({}));
          if (!r.ok || data.error) throw new Error(data.error || ("HTTP " + r.status));

          balMeta.textContent = data.title || "–°–µ–≥–æ–¥–Ω—è";
          const ops = Array.isArray(data.ops) ? data.ops : [];

          if (!ops.length){
            balOps.innerHTML = `<div class="op"><div class="op-top"><div class="op-title">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div><div class="op-amt">‚Äî</div></div></div>`;
            return;
          }

          balOps.innerHTML = ops.map((op) => {
            const amt = Number(op.amount_cents || 0);
            const cls = amt >= 0 ? "pos" : "neg";
            const signAmt = fmtSigned(amt);
            const title = (op.title || "–û–ø–µ—Ä–∞—Ü–∏—è").replace(/</g,"&lt;").replace(/>/g,"&gt;");
            const sub = (op.subtitle || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
            const whenStr = fmtOpWhen(op.occurred_at, data.date);
            const posting = op.posting_number ? `<span class="pill">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${String(op.posting_number)}</span>` : "";
            const clickable = (op.is_sale_delivery && op.posting_number) ? "clickable" : "";
            const dataPosting = op.posting_number ? `data-posting="${String(op.posting_number).replace(/"/g,'&quot;')}"` : "";
            const dataSale = op.is_sale_delivery ? `data-sale="1"` : "";
            return `
              <div class="op ${clickable}" ${dataPosting} ${dataSale}>
                <div class="op-top">
                  <div>
                    <div class="op-title">${title}</div>
                    ${whenStr ? `<div class="op-time">${whenStr}</div>` : ``}
                    ${sub ? `<div class="op-sub">${sub}</div>` : ``}
                  </div>
                  <div class="op-amt ${cls}">${signAmt}</div>
                </div>
                ${posting ? `<div class="op-foot">${posting}</div>` : ``}
                <div class="op-details"></div>
              </div>
            `;
          }).join("");

          // –∫–ª–∏–∫–∏: —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é" (–ø—Ä–æ–¥–∞–∂–∞)
          balOps.querySelectorAll(".op.clickable").forEach((el) => {
            el.addEventListener("click", async () => {
              const postingNumber = el.getAttribute("data-posting");
              if (!postingNumber) return;

              const detailsEl = el.querySelector(".op-details");
              if (!detailsEl) return;

              // toggle if already loaded
              if (detailsEl.getAttribute("data-loaded") === "1") {
                const isOpen = detailsEl.style.display === "flex";
                detailsEl.style.display = isOpen ? "none" : "flex";
                return;
              }

              detailsEl.style.display = "flex";
              detailsEl.innerHTML = `<div class="op-sub">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏‚Ä¶</div>`;

              try{
                const params = new URLSearchParams({ clientId, apiKey, posting_number: postingNumber });
                const dUrl = `/api/balance/sale/detail?${params.toString()}`;
                const rr = await fetch(dUrl);
                const dj = await rr.json().catch(()=>({}));
                if (!rr.ok || dj.error) throw new Error(dj.error || ("HTTP " + rr.status));

                const lines = Array.isArray(dj.lines) ? dj.lines : [];
                const note = dj.note;

                const htmlLines = lines.map((ln) => {
                  const a = Number(ln.amount_cents || 0);
                  const c = a >= 0 ? "pos" : "neg";
                  const pct = (ln.percent !== null && ln.percent !== undefined) ? ` <span style="color:var(--muted);font-weight:700;">(${ln.percent}%)</span>` : "";
                  return `<div class="op-line">
                    <div class="t">${String(ln.title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}${pct}</div>
                    <div class="a ${c}">${fmtSigned(a)}</div>
                  </div>`;
                }).join("");

                const noteHtml = note ? `<div class="op-note">${String(note.title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}: <b>${fmtSigned(Number(note.amount_cents||0))}</b>${(note.percent!==null&&note.percent!==undefined)?` (${note.percent}%)`:``}</div>` : "";

                detailsEl.innerHTML = htmlLines + noteHtml;
                detailsEl.setAttribute("data-loaded","1");
              } catch(e){
                detailsEl.innerHTML = `<div class="op-sub">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é</div>`;
                detailsEl.setAttribute("data-loaded","1");
              }
            });
          });

        } catch(e){
          setBalError(String(e.message || e));
          balMeta.textContent = "–û—à–∏–±–∫–∞";
          balOps.innerHTML = `<div class="op"><div class="op-top"><div class="op-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏</div><div class="op-amt">‚Äî</div></div></div>`;
        }
      })();
    }
    function closeBalModal(){ balModalBg.style.display = "none"; }


    $("keysBtn").addEventListener("click", openModal);

    balCloseBtn.addEventListener("click", closeBalModal);
    balModalBg.addEventListener("click", (e) => { if (e.target === balModalBg) closeBalModal(); });

    // –±–∞–ª–∞–Ω—Å: –æ—Ç–∫—Ä—ã—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
    balanceCard.classList.add("clickable");
    balanceCard.addEventListener("click", openBalModal);

    $("cancelBtn").addEventListener("click", closeModal);
    modalBg.addEventListener("click", (e) => { if (e.target === modalBg) closeModal(); });

    $("saveBtn").addEventListener("click", async () => {
      const clientId = clientIdEl.value.trim();
      const apiKey = apiKeyEl.value.trim();
      if (!clientId || !apiKey) {
        modalErr.textContent = "–ó–∞–ø–æ–ª–Ω–∏ Client ID –∏ Api-Key";
        modalErr.style.display = "block";
        return;
      }
      localStorage.setItem("ozon_clientId", clientId);
      localStorage.setItem("ozon_apiKey", apiKey);
      closeModal();
      await load();
    });

    async function load(){
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();

      if (!clientId || !apiKey){
        setStatus("–Ω—É–∂–Ω—ã –∫–ª—é—á–∏", true);
        openModal();
        return;
      }

      try{
        refreshBtn.disabled = true;
        refreshIcon.classList.add("spin");
        setStatus("–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶");

        const url = `/api/dashboard/today?clientId=${encodeURIComponent(clientId)}&apiKey=${encodeURIComponent(apiKey)}`;
        const r = await fetch(url);
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || ("HTTP " + r.status));

        if (data.title) $("subtitle").textContent = data.title;

        $("orders").textContent = data.orders ?? data.ordersCount ?? "‚Äî";
        $("ordersSum").textContent = fmtMoneyFromCents(data.orders_sum ?? data.ordersAmount);
        $("cancels").textContent = data.cancels ?? data.cancelsCount ?? "‚Äî";
        $("cancelsSum").textContent = fmtMoneyFromCents(data.cancels_sum ?? data.cancelsAmount);

        // –≤—ã–∫—É–ø—ã / –≤–æ–∑–≤—Ä–∞—Ç—ã (–ø–æ –¥–µ–Ω—å–≥–∞–º –∏–∑ finance/balance)
        const buyoutsCents = (data.buyouts_sum_cents ?? data.buyouts_sum ?? null);
        const returnsCents = (data.returns_sum_cents ?? data.returns_sum ?? null);

        // –í—ã–∫—É–ø—ã: –≤—Å–µ–≥–¥–∞ + –∏ –∑–µ–ª—ë–Ω—ã–º
        if (buyoutsCents !== null && buyoutsCents !== undefined) {
          const abs = Math.abs(Number(buyoutsCents) || 0);
          $("buyoutsSum").textContent = "+" + fmtMoneyFromCents(abs);
        } else if (data.buyouts_sum_text) {
          const t = String(data.buyouts_sum_text);
          $("buyoutsSum").textContent = t.startsWith("+") ? t : ("+" + t.replace("‚àí","").replace("-",""));
        } else {
          $("buyoutsSum").textContent = "‚Äî";
        }

        // –í–æ–∑–≤—Ä–∞—Ç—ã: –≤—Å–µ–≥–¥–∞ - –∏ –∫—Ä–∞—Å–Ω—ã–º
        if (returnsCents !== null && returnsCents !== undefined) {
          const abs = Math.abs(Number(returnsCents) || 0);
          $("returnsSum").textContent = "-" + fmtMoneyFromCents(abs);
        } else if (data.returns_sum_text) {
          const t = String(data.returns_sum_text);
          $("returnsSum").textContent = (t.startsWith("-") || t.startsWith("‚àí")) ? t : ("-" + t);
        } else {
          $("returnsSum").textContent = "‚Äî";
        }

// –±–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ —Å–º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å)
        if (data.balance_text && data.balance_text !== "‚Äî") $("balance").textContent = data.balance_text;
        else if (data.balance_cents !== null && data.balance_cents !== undefined) $("balance").textContent = fmtMoneyFromCents(data.balance_cents);
        else $("balance").textContent = "‚Äî";

        // –¥–∏–Ω–∞–º–∏–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∑–∞ –¥–µ–Ω—å (closing - opening)
        try {
          const deltaEl = $("balanceDelta");
          if (deltaEl) {
            const opening = (data.balance_opening ?? data.balance_opening_cents ?? null);
            const closing = (data.balance_closing ?? data.balance_cents ?? data.balance_closing_cents ?? null);
            const hasBoth = opening !== null && opening !== undefined && closing !== null && closing !== undefined;
            if (!hasBoth) {
              deltaEl.textContent = "";
              deltaEl.className = "delta";
            } else {
              const delta = Number(closing) - Number(opening);
              if (!Number.isFinite(delta) || delta === 0) {
                deltaEl.textContent = "";
                deltaEl.className = "delta";
              } else {
                const abs = Math.abs(delta);
                const sign = delta > 0 ? "+" : "-";
                deltaEl.textContent = `${sign}${fmtMoneyFromCents(abs)} —Å–µ–≥–æ–¥–Ω—è`;
                deltaEl.className = `delta ${delta > 0 ? "pos" : "neg"}`;
              }
            }
          }
        } catch (_) {}


// –í—ã–∫—É–ø—ã / –í–æ–∑–≤—Ä–∞—Ç—ã (–ø–æ offer_id)
const topN = (arr, n=5) => Array.isArray(arr) ? arr.slice(0, n) : [];
const renderList = (el, arr) => {
  if (!el) return;
  const rows = topN(arr, 5);
  if (!rows.length) { el.textContent = ""; return; }
  el.innerHTML = rows.map(x => (
    `<div class="row"><span class="k">${String(x.offer_id)}</span><span>${Number(x.qty||0)}</span></div>`
  )).join("");
};


        setLastUpdated(data.updated_at);
        setStatus("–∞–∫—Ç—É–∞–ª—å–Ω–æ");
      } catch(e){
        setStatus("–æ—à–∏–±–∫–∞ Ozon API", true);

try{
  $("buyoutsSum").textContent = "‚Äî";
  $("returnsSum").textContent = "‚Äî";
  const bd = $("balanceDelta");
  if (bd) { bd.textContent = ""; bd.className = "delta"; }
  
  
}catch(_){}
      } finally{
        refreshIcon.classList.remove("spin");
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener("click", () => { applyFullscreen(); load(); });
    load();
  </script>
</body>
</html>
