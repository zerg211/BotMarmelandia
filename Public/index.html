<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ Ozon</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0B0F14; --card:#121923; --text:#EAF0FF; --muted:#93A4C7;
      --accent:#4DA3FF; --danger:#FF5A6A; --success:#3CCB7F; --line: rgba(255,255,255,.08);
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:sans-serif; }
    .app{ padding: 20px; display:flex; flex-direction:column; gap:14px; }
    .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card{ 
      background:var(--card); border-radius:16px; padding:16px; 
      border:1px solid var(--line); display:flex; flex-direction:column; gap:8px;
    }
    .label{ font-size:12px; color:var(--muted); }
    .value{ font-size:24px; font-weight:bold; }
    .value.small{ font-size:18px; }
    .footer{ margin-top:20px; display:flex; justify-content:space-between; }
    .btn{ 
        background:var(--accent); border:none; color:#fff; padding:10px 16px; 
        border-radius:12px; font-weight:bold; cursor:pointer; 
    }
    .btn.secondary{ background:var(--line); }
    
    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.8);
      display:none; align-items:center; justify-content:center; padding:20px;
    }
    .modal{ background:var(--card); padding:20px; border-radius:16px; width:100%; max-width:400px; }
    input{ 
        width:100%; padding:12px; margin:8px 0; border-radius:8px; 
        border:1px solid var(--line); background:#000; color:#fff; 
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div style="font-size:20px; font-weight:bold;">–î–∞—à–±–æ—Ä–¥</div>
        <div id="date" style="font-size:12px; color:var(--muted);">–°–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div id="status" class="label">–æ–±–Ω–æ–≤–ª–µ–Ω–æ</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">–ó–∞–∫–∞–∑—ã</div>
        <div class="value" id="orders">0</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞</div>
        <div class="value small" id="ordersSum">0 ‚ÇΩ</div>
      </div>
      <div class="card">
        <div class="label">–û—Ç–º–µ–Ω—ã</div>
        <div class="value" id="cancels">0</div>
      </div>
      <div class="card">
        <div class="label">–ë–∞–ª–∞–Ω—Å</div>
        <div class="value small" id="balance">0 ‚ÇΩ</div>
      </div>
    </div>

    <div class="footer">
      <button class="btn secondary" id="keysBtn">üîë –ö–ª—é—á–∏</button>
      <button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBg">
    <div class="modal">
      <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Ozon</h3>
      <input id="clientId" placeholder="Client ID" />
      <input id="apiKey" placeholder="API Key" />
      <button class="btn" id="saveBtn" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn secondary" id="closeBtn" style="width:100%; margin-top:8px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const tg = window.Telegram?.WebApp;
    if(tg) tg.expand();

    async function load() {
      const cId = localStorage.getItem("ozon_clientId");
      const aKey = localStorage.getItem("ozon_apiKey");
      if(!cId || !aKey) { $("modalBg").style.display="flex"; return; }

      try {
        $("status").textContent = "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
        const r = await fetch(`/api/dashboard/today?clientId=${cId}&apiKey=${aKey}`);
        const data = await r.json();
        
        $("orders").textContent = data.ordersCount;
        $("ordersSum").textContent = (data.ordersAmount/100).toLocaleString() + " ‚ÇΩ";
        $("cancels").textContent = data.cancelsCount;
        $("balance").textContent = (data.balance_cents/100).toLocaleString() + " ‚ÇΩ";
        $("date").textContent = data.date;
        $("status").textContent = "–∞–∫—Ç—É–∞–ª—å–Ω–æ";
      } catch(e) {
        $("status").textContent = "–æ—à–∏–±–∫–∞";
      }
    }

    $("keysBtn").onclick = () => $("modalBg").style.display="flex";
    $("closeBtn").onclick = () => $("modalBg").style.display="none";
    $("refreshBtn").onclick = load;
    $("saveBtn").onclick = () => {
      localStorage.setItem("ozon_clientId", $("clientId").value);
      localStorage.setItem("ozon_apiKey", $("apiKey").value);
      $("modalBg").style.display="none";
      load();
    };

    load();
  </script>
</body>
</html>
