<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0B0F14; --card:#121923; --text:#EAF0FF; --muted:#93A4C7;
      --accent:#4DA3FF; --danger:#FF5A6A; --success:#3CCB7F; --line: rgba(255,255,255,.08);

      /* ‚úÖ –í–ï–†–•–ù–ò–ô "–§–£–¢–ï–†" (–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∏–∂–µ —à–∞–ø–∫–∏ Telegram) */
      --top-gap: 44px;            /* –µ—Å–ª–∏ –º–∞–ª–æ/–º–Ω–æ–≥–æ ‚Äî –º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ */
    }
    *{box-sizing:border-box;}

    html, body { height: 100%; overflow: hidden; }
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .app{
      height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));
      min-height: var(--tg-viewport-stable-height, var(--tg-viewport-height, 100dvh));

      /* ‚úÖ –¥–æ–±–∞–≤–∏–ª–∏ top-gap */
      padding:
        calc(var(--top-gap) + env(safe-area-inset-top) + 16px)
        calc(16px + env(safe-area-inset-right))
        calc(16px + env(safe-area-inset-bottom))
        calc(16px + env(safe-area-inset-left));

      display:flex;flex-direction:column;gap:14px;
    }

    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;}
    .title{font-size:20px;font-weight:900;letter-spacing:.2px;}
    .sub{font-size:12px;color:var(--muted);}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(77,163,255,.15);color:var(--accent);white-space:nowrap;}
    .badge.danger{background:rgba(255,90,106,.15);color:var(--danger);}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
    .card{
      background:var(--card);border-radius:16px;padding:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      display:flex;flex-direction:column;gap:10px;min-height:110px;border:1px solid var(--line);
    }
    .label{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .value{font-size:28px;font-weight:900;letter-spacing:.2px;}
    .value.small{font-size:22px;}
    .value.pos{color:var(--success);}
    .value.neg{color:var(--danger);}
    .footer{
      margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:12px;
      color:var(--muted);font-size:12px;
    }
    .btn{
      border:1px solid var(--line);background:rgba(77,163,255,.18);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .btn.secondary{background:rgba(255,255,255,.06);}
    .btn:active{transform:scale(.99);}
    .spin{animation:spin .8s linear infinite;}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}


.mini-list{
  font-size:12px;color:var(--muted);line-height:1.35;
  max-height:72px;overflow:auto;padding-right:4px;
}
.mini-list .row{display:flex;justify-content:space-between;gap:10px;}
.mini-list .k{color:var(--text);font-weight:700;}

    /* modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal{
      width:min(520px,100%);
      background:var(--card);border:1px solid var(--line);
      border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.5);
      padding:16px;display:flex;flex-direction:column;gap:12px;
    }
    .modal h3{margin:0;font-size:16px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    .field label{font-size:12px;color:var(--muted);}
    .field input{
      width:100%;padding:12px 12px;border-radius:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.04);
      color:var(--text);outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row .btn{flex:1;}
    .err{font-size:12px;color:var(--danger);display:none;}
    @media (max-width:380px){.value{font-size:24px}.card{min-height:96px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title" id="title">–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div class="sub" id="subtitle">FBO ¬∑ –°–µ–≥–æ–¥–Ω—è ¬∑ Europe/Moscow</div>
      </div>
      <div class="badge" id="status">–≥–æ—Ç–æ–≤–æ</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">–ó–∞–∫–∞–∑—ã <span class="badge">—à—Ç</span></div>
        <div class="value" id="orders">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ <span class="badge">‚ÇΩ</span></div>
        <div class="value small" id="ordersSum">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–û—Ç–º–µ–Ω—ã <span class="badge danger">—à—Ç</span></div>
        <div class="value" id="cancels">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ –æ—Ç–º–µ–Ω <span class="badge danger">‚ÇΩ</span></div>
        <div class="value small" id="cancelsSum">‚Äî</div>
      </div>

<div class="card">
  <div class="label">–í—ã–∫—É–ø—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge">‚ÇΩ</span></div>
  <div class="value small pos" id="buyoutsSum">‚Äî</div>
</div>
<div class="card">
  <div class="label">–í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge danger">‚ÇΩ</span></div>
  <div class="value small neg" id="returnsSum">‚Äî</div>
</div>

<div class="card">
  <div class="label">–ë–∞–ª–∞–Ω—Å –∫–∞–±–∏–Ω–µ—Ç–∞ <span class="badge">‚ÇΩ</span></div>
  <div class="value small" id="balance">‚Äî</div>
</div>

    </div>

    <div class="footer">
      <div id="updatedAt">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ‚Äî</div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn secondary" id="keysBtn">üîë –ö–ª—é—á–∏</button>
        <button class="btn" id="refreshBtn">
          <svg id="refreshIcon" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M21 12a9 9 0 1 1-2.64-6.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 3v7h-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-backdrop" id="modalBg">
    <div class="modal">
      <h3>–ö–ª—é—á–∏ Ozon Seller</h3>

      <div class="field">
        <label>Client ID</label>
        <input id="clientId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 2396143" />
      </div>

      <div class="field">
        <label>Api-Key</label>
        <input id="apiKey" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 6157f0ba-..." />
      </div>

      <div class="err" id="modalErr">–û—à–∏–±–∫–∞</div>

      <div class="row">
        <button class="btn secondary" id="cancelBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    function applyFullscreen(){
      if (!tg) return;
      tg.ready();
      tg.expand();
      tg.disableVerticalSwipes?.();
      tg.requestFullscreen?.();
    }
    applyFullscreen();
    try { tg?.onEvent?.("viewportChanged", applyFullscreen); } catch(e) {}

    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const updatedAtEl = $("updatedAt");
    const refreshBtn = $("refreshBtn");
    const refreshIcon = $("refreshIcon");

    const modalBg = $("modalBg");
    const clientIdEl = $("clientId");
    const apiKeyEl = $("apiKey");
    const modalErr = $("modalErr");

    function setStatus(text, danger=false){
      statusEl.textContent = text;
      statusEl.className = "badge" + (danger ? " danger" : "");
    }
    function setLastUpdated(iso){
      const d = iso ? new Date(iso) : new Date();
      updatedAtEl.textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + d.toLocaleString("ru-RU");
    }
    function fmtMoneyFromCents(cents){
      if (cents === null || cents === undefined) return "‚Äî";
      const rub = (Number(cents) / 100);
      return new Intl.NumberFormat("ru-RU", {minimumFractionDigits:2, maximumFractionDigits:2}).format(rub);
    }

    function openModal(){
      modalErr.style.display = "none";
      clientIdEl.value = localStorage.getItem("ozon_clientId") || "";
      apiKeyEl.value = localStorage.getItem("ozon_apiKey") || "";
      modalBg.style.display = "flex";
      applyFullscreen();
    }
    function closeModal(){ modalBg.style.display = "none"; }

    $("keysBtn").addEventListener("click", openModal);
    $("cancelBtn").addEventListener("click", closeModal);
    modalBg.addEventListener("click", (e) => { if (e.target === modalBg) closeModal(); });

    $("saveBtn").addEventListener("click", async () => {
      const clientId = clientIdEl.value.trim();
      const apiKey = apiKeyEl.value.trim();
      if (!clientId || !apiKey) {
        modalErr.textContent = "–ó–∞–ø–æ–ª–Ω–∏ Client ID –∏ Api-Key";
        modalErr.style.display = "block";
        return;
      }
      localStorage.setItem("ozon_clientId", clientId);
      localStorage.setItem("ozon_apiKey", apiKey);
      closeModal();
      await load();
    });

    async function load(){
      const clientId = (localStorage.getItem("ozon_clientId") || "").trim();
      const apiKey = (localStorage.getItem("ozon_apiKey") || "").trim();

      if (!clientId || !apiKey){
        setStatus("–Ω—É–∂–Ω—ã –∫–ª—é—á–∏", true);
        openModal();
        return;
      }

      try{
        refreshBtn.disabled = true;
        refreshIcon.classList.add("spin");
        setStatus("–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶");

        const url = `/api/dashboard/today?clientId=${encodeURIComponent(clientId)}&apiKey=${encodeURIComponent(apiKey)}`;
        const r = await fetch(url);
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || ("HTTP " + r.status));

        if (data.title) $("subtitle").textContent = data.title;

        $("orders").textContent = data.orders ?? data.ordersCount ?? "‚Äî";
        $("ordersSum").textContent = fmtMoneyFromCents(data.orders_sum ?? data.ordersAmount);
        $("cancels").textContent = data.cancels ?? data.cancelsCount ?? "‚Äî";
        $("cancelsSum").textContent = fmtMoneyFromCents(data.cancels_sum ?? data.cancelsAmount);

        // –≤—ã–∫—É–ø—ã / –≤–æ–∑–≤—Ä–∞—Ç—ã (–ø–æ –¥–µ–Ω—å–≥–∞–º –∏–∑ finance/balance)
        const buyoutsCents = (data.buyouts_sum_cents ?? data.buyouts_sum ?? null);
        const returnsCents = (data.returns_sum_cents ?? data.returns_sum ?? null);

        // –í—ã–∫—É–ø—ã: –≤—Å–µ–≥–¥–∞ + –∏ –∑–µ–ª—ë–Ω—ã–º
        if (buyoutsCents !== null && buyoutsCents !== undefined) {
          const abs = Math.abs(Number(buyoutsCents) || 0);
          $("buyoutsSum").textContent = "+" + fmtMoneyFromCents(abs);
        } else if (data.buyouts_sum_text) {
          const t = String(data.buyouts_sum_text);
          $("buyoutsSum").textContent = t.startsWith("+") ? t : ("+" + t.replace("‚àí","").replace("-",""));
        } else {
          $("buyoutsSum").textContent = "‚Äî";
        }

        // –í–æ–∑–≤—Ä–∞—Ç—ã: –≤—Å–µ–≥–¥–∞ - –∏ –∫—Ä–∞—Å–Ω—ã–º
        if (returnsCents !== null && returnsCents !== undefined) {
          const abs = Math.abs(Number(returnsCents) || 0);
          $("returnsSum").textContent = "-" + fmtMoneyFromCents(abs);
        } else if (data.returns_sum_text) {
          const t = String(data.returns_sum_text);
          $("returnsSum").textContent = (t.startsWith("-") || t.startsWith("‚àí")) ? t : ("-" + t);
        } else {
          $("returnsSum").textContent = "‚Äî";
        }

// –±–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ —Å–º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å)
        if (data.balance_text && data.balance_text !== "‚Äî") $("balance").textContent = data.balance_text;
        else if (data.balance_cents !== null && data.balance_cents !== undefined) $("balance").textContent = fmtMoneyFromCents(data.balance_cents);
        else $("balance").textContent = "‚Äî";


// –í—ã–∫—É–ø—ã / –í–æ–∑–≤—Ä–∞—Ç—ã (–ø–æ offer_id)
const topN = (arr, n=5) => Array.isArray(arr) ? arr.slice(0, n) : [];
const renderList = (el, arr) => {
  if (!el) return;
  const rows = topN(arr, 5);
  if (!rows.length) { el.textContent = ""; return; }
  el.innerHTML = rows.map(x => (
    `<div class="row"><span class="k">${String(x.offer_id)}</span><span>${Number(x.qty||0)}</span></div>`
  )).join("");
};


        setLastUpdated(data.updated_at);
        setStatus("–∞–∫—Ç—É–∞–ª—å–Ω–æ");
      } catch(e){
        setStatus("–æ—à–∏–±–∫–∞ Ozon API", true);

try{
  $("buyoutsSum").textContent = "‚Äî";
  $("returnsSum").textContent = "‚Äî";
  
  
}catch(_){}
      } finally{
        refreshIcon.classList.remove("spin");
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener("click", () => { applyFullscreen(); load(); });
    load();
  </script>
</body>
</html>
