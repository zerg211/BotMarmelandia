<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ú–æ—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0B0F14; --card:#121923; --text:#EAF0FF; --muted:#93A4C7;
      --accent:#4DA3FF; --danger:#FF5A6A; --success:#3CCB7F; --line: rgba(255,255,255,.08);
      --top-gap: 44px;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:sans-serif; }
    .app{ padding: calc(var(--top-gap) + 16px) 16px; display:flex; flex-direction:column; gap:14px; }
    .top{ display:flex; justify-content:space-between; align-items:flex-end; }
    .grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .card{ 
      background:var(--card); border-radius:16px; padding:14px; border:1px solid var(--line);
      display:flex; flex-direction:column; gap:10px; min-height:110px;
    }
    .card.wide { grid-column: span 2; }
    .label{ font-size:12px; color:var(--muted); }
    .value{ font-size:26px; font-weight:900; }
    .value.small{ font-size:20px; }
    .badge{ font-size:10px; padding:2px 6px; border-radius:999px; background:rgba(77,163,255,0.1); color:var(--accent); }
    .pos{ color:var(--success); }
    .neg{ color:var(--danger); }
    .footer{ margin-top:20px; display:flex; justify-content:space-between; align-items:center; }
    .btn{ border:1px solid var(--line); background:rgba(77,163,255,0.2); color:#fff; padding:10px 14px; border-radius:12px; font-weight:bold; cursor:pointer;}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div style="font-size:20px; font-weight:900">–î–∞—à–±–æ—Ä–¥</div>
        <div id="subtitle" style="font-size:12px; color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div id="status" class="badge">–≥–æ—Ç–æ–≤–æ</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">–ó–∞–∫–∞–∑—ã <span class="badge">—à—Ç</span></div>
        <div class="value" id="orders">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ <span class="badge">‚ÇΩ</span></div>
        <div class="value small" id="ordersSum">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–û—Ç–º–µ–Ω—ã <span class="badge danger">—à—Ç</span></div>
        <div class="value" id="cancels">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°—É–º–º–∞ –æ—Ç–º–µ–Ω <span class="badge danger">‚ÇΩ</span></div>
        <div class="value small" id="cancelsSum">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–í—ã–∫—É–ø—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge">‚ÇΩ</span></div>
        <div class="value small pos" id="buyoutsSum">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–í–æ–∑–≤—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è <span class="badge danger">‚ÇΩ</span></div>
        <div class="value small neg" id="returnsSum">‚Äî</div>
      </div>
      <div class="card wide" id="balanceCard">
        <div class="label">–ë–∞–ª–∞–Ω—Å –∫–∞–±–∏–Ω–µ—Ç–∞ <span class="badge">‚ÇΩ</span></div>
        <div class="value small" id="balance">‚Äî</div>
        <div id="balanceDelta" style="font-size:11px; margin-top:-5px"></div>
      </div>
    </div>

    <div class="footer">
      <div id="updatedAt" style="font-size:10px; color:var(--muted)">‚Äî</div>
      <div style="display:flex; gap:8px">
        <button class="btn" id="keysBtn" style="background:rgba(255,255,255,0.05)">üîë –ö–ª—é—á–∏</button>
        <button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if(tg) tg.expand();
    const $ = (id) => document.getElementById(id);

    function fmt(cents) {
      if (cents === null || cents === undefined) return "‚Äî";
      return (Number(cents) / 100).toLocaleString("ru-RU", {minimumFractionDigits: 2}) + " ‚ÇΩ";
    }

    async function load() {
      const cId = localStorage.getItem("ozon_clientId");
      const aKey = localStorage.getItem("ozon_apiKey");
      if(!cId || !aKey) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–∏!"); return; }

      $("status").textContent = "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
      try {
        const r = await fetch(`/api/dashboard/today?clientId=${cId}&apiKey=${aKey}`);
        const data = await r.json();
        
        $("subtitle").textContent = data.title;
        $("orders").textContent = data.ordersCount;
        $("ordersSum").textContent = fmt(data.ordersAmount);
        $("cancels").textContent = data.cancelsCount;
        $("cancelsSum").textContent = fmt(data.cancelsAmount);
        $("buyoutsSum").textContent = "+" + fmt(data.buyouts_sum_cents);
        $("returnsSum").textContent = "-" + fmt(data.returns_sum_cents);
        $("balance").textContent = fmt(data.balance_cents);
        
        const delta = data.balance_cents - data.balance_opening_cents;
        if(delta !== 0) {
            $("balanceDelta").textContent = (delta > 0 ? "+" : "") + fmt(delta) + " –∑–∞ —Å–µ–≥–æ–¥–Ω—è";
            $("balanceDelta").style.color = delta > 0 ? "var(--success)" : "var(--danger)";
        }

        $("updatedAt").textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
        $("status").textContent = "–≥–æ—Ç–æ–≤–æ";
      } catch(e) { $("status").textContent = "–æ—à–∏–±–∫–∞"; }
    }

    $("refreshBtn").onclick = load;
    $("keysBtn").onclick = () => {
        const c = prompt("Client ID", localStorage.getItem("ozon_clientId") || "");
        const k = prompt("API Key", localStorage.getItem("ozon_apiKey") || "");
        if(c && k) {
            localStorage.setItem("ozon_clientId", c);
            localStorage.setItem("ozon_apiKey", k);
            load();
        }
    };
    load();
  </script>
</body>
</html>
